<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <meta name='viewport' content='width=device-width, initial-scale=0.5, maximum-scale=0.5, user-scalable=0'/>
    </head>

    <body>
        <div class="box">
            <img class="imagem_chat" src="{{ url_for('static', filename='lotus_chat.png') }}">
            <a href="{{ url_for('trocar_usuario') }}" ><button class="trocar_usuario">Trocar usuario</button></a>
            <div class="chat" >
            {% for mensagem in mensagems %}
            {% if mensagem.nome == session.user %}
                <span class="message_mine"><strong>{{mensagem.nome}}:</strong>
                    {{mensagem.message}} <span class="time">{{mensagem.time}}</span></span>
            {% else %}
                <span class="message"><strong>{{mensagem.nome}}:</strong>
                    {{mensagem.message}} <span class="time">{{mensagem.time}}</span></span>
            {% endif %}
            {% endfor %}

            </div>
            <div class="inputs">
                <form  id="chat">
                    <input type="hidden" value="{{ session.user }}">
                    <input type="text" placeholder="Insira sua mensagem" autofocus>
                    <button type="submit">Enviar</button>
                </form>

            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
        <script>
            window.onload = function(){
                function addToChat(msg){
                    const span = document.createElement("span");
                    const chat = document.querySelector(".chat");
                    if (msg.nome === "{{session.user}}"){
                        span.className = "message_mine"
                    }
                    else{
                        span.className = "message"
                    }
                    span.innerHTML = `<strong>${msg.nome}:</strong> ${msg.message} <span class="time">${msg.time}</span>`
                    chat.append(span);
                }
                const uri = window.location.origin
                const socket = io(uri);

                socket.on('conect', () => {
                    socket.send('usuario conectado')
                });

                document.querySelector('form').addEventListener("submit", function(){
                    event.preventDefault();
                    socket.emit('sendMessage', {nome: event.target[0].value, message: event.target[1].value})

                    event.target[1].value = "";
                });

                socket.on('getMsg', (msg) => {
                    addToChat(msg);
                    var heightPage = document.body.scrollHeight;
                    window.scrollTo(0 , heightPage);
                });
            }
        </script>
    </body>
</html>
